<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pool Document Generator</title>
    <style>
      :root {
        --bg: #0b1220;
        --card: #111a2e;
        --text: #e8eefc;
        --muted: #a8b3cf;
        --border: rgba(255, 255, 255, 0.12);
        --danger: #ff5a67;
        --btn: #2b66ff;
        --btnText: #ffffff;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: radial-gradient(1200px 900px at 20% 0%, #142046 0%, var(--bg) 55%);
        color: var(--text);
      }
      .container {
        max-width: 980px;
        margin: 0 auto;
        padding: 24px;
      }
      h1 {
        font-size: 26px;
        margin: 0 0 6px 0;
      }
      .sub {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 18px;
        line-height: 1.4;
      }
      .card {
        background: rgba(17, 26, 46, 0.92);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        margin: 14px 0;
        box-shadow: 0 6px 22px rgba(0, 0, 0, 0.22);
        backdrop-filter: blur(6px);
      }
      .card h2 {
        font-size: 16px;
        margin: 0 0 12px 0;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }
      @media (min-width: 860px) {
        .grid2 {
          grid-template-columns: 1fr 1fr;
        }
      }
      label {
        display: block;
        font-size: 13px;
        margin-bottom: 6px;
      }
      .req {
        color: var(--danger);
        font-weight: 700;
        margin-left: 6px;
      }
      input,
      textarea {
        width: 100%;
        box-sizing: border-box;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
        padding: 10px 12px;
        outline: none;
        font-size: 14px;
      }
      textarea {
        min-height: 90px;
        resize: vertical;
      }
      input::placeholder,
      textarea::placeholder {
        color: rgba(232, 238, 252, 0.42);
      }
      .help {
        color: var(--muted);
        font-size: 12px;
        margin-top: 6px;
        line-height: 1.35;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .row input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }
      .hr {
        height: 1px;
        background: var(--border);
        margin: 16px 0;
      }
      .btnrow {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      button {
        border: none;
        border-radius: 14px;
        padding: 12px 14px;
        font-weight: 650;
        cursor: pointer;
        font-size: 14px;
      }
      .primary {
        background: var(--btn);
        color: var(--btnText);
        flex: 1;
        min-width: 240px;
      }
      .secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        border: 1px solid var(--border);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .error {
        color: var(--danger);
        font-size: 13px;
        margin-top: 10px;
        white-space: pre-wrap;
      }
      .status {
        color: var(--muted);
        font-size: 13px;
        margin-top: 10px;
        white-space: pre-wrap;
      }
      .downloads {
        margin-top: 12px;
        display: grid;
        gap: 10px;
      }
      .dlitem {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.03);
      }
      .dlmeta {
        min-width: 0;
      }
      .dllabel {
        font-size: 13px;
        font-weight: 650;
      }
      .dlfile {
        font-size: 12px;
        color: var(--muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 540px;
      }
      .note {
        font-size: 12px;
        color: var(--muted);
        margin-top: 8px;
        line-height: 1.35;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      .smallbtn {
        padding: 10px 12px;
      }
      .warn {
        color: #ffd27d;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Pool Document Generator</h1>
      <div class="sub">
        This is a <b>no-build</b> static site.
        <br />
        It will load your 4 DOCX templates and replace placeholders like
        <span class="mono">{{VESSEL_NAME}}</span>.
      </div>

      <div class="card">
        <h2>Section 1: Agreement Date</h2>
        <label for="agreementDate">Agreement Date <span class="req">*</span></label>
        <input id="agreementDate" type="date" required />
        <div class="help" id="agreementDateHelp">Used in: All documents</div>
      </div>

      <div class="card">
        <h2>Section 2: Vessel Information</h2>
        <div class="grid2">
          <div>
            <label for="vesselName">Vessel Name <span class="req">*</span></label>
            <input id="vesselName" type="text" placeholder="e.g., MT PACIFIC VOYAGER" required />
            <div class="help">Used in: All documents</div>
          </div>
          <div>
            <label for="classSoc">Classification Society</label>
            <input id="classSoc" type="text" placeholder="e.g., ABS, DNV, LR, NK" />
            <div class="help">Used in: TCP</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Section 3: Participant/Owner Information</h2>
        <label for="participantName">Participant/Owner Name <span class="req">*</span></label>
        <input
          id="participantName"
          type="text"
          placeholder="Full legal name of participant/owner company"
          required
        />
        <div class="help">Used in: Pool Agreement, TCP, TPC Warranty</div>

        <div class="hr"></div>

        <label for="participantAddress">Participant Address</label>
        <textarea id="participantAddress" placeholder="Complete registered address"></textarea>
        <div class="help" id="countryHelp">
          Used in: Pool Agreement, TCP • Country detected for TCP: (not detected)
        </div>

        <div class="hr"></div>

        <label for="noticeDetail">Notices Details</label>
        <textarea
          id="noticeDetail"
          placeholder="Paste complete notices details here, e.g.:
Attention: John Smith, Fleet Manager
Email: fleet@company.com
Tel: +65 1234 5678
Fax: +65 1234 5678"
        ></textarea>
        <div class="help">Used in: Pool Agreement</div>
      </div>

      <div class="card">
        <h2>Section 4: Appendix 2 – Disponent Owners</h2>
        <div class="row">
          <input id="appendix2" type="checkbox" />
          <label for="appendix2" style="margin: 0;">
            Appendix 2 is applicable (vessel under head time charter)
          </label>
        </div>

        <div id="appendix2Fields" style="display: none; margin-top: 14px;">
          <div class="grid2">
            <div>
              <label for="headTcpDate">Head Time Charter Party Date</label>
              <input id="headTcpDate" type="date" />
              <div class="help">Used in: Pool Agreement</div>
            </div>
            <div>
              <label for="timeCharterers">Time Charterers</label>
              <input id="timeCharterers" type="text" placeholder="Name of time charterers" />
              <div class="help">Used in: Pool Agreement</div>
            </div>
          </div>
          <div class="note">
            If ticked, <span class="mono">{{TIME_CHARTERER_APPENDIX2}}</span> is replaced with your input.
            If not ticked, it defaults to <b>Tankers International Limited</b>.
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Section 5: Banking Details</h2>
        <label for="bankingDetail">Banking Details</label>
        <textarea
          id="bankingDetail"
          placeholder="Paste complete banking details here, e.g.:
Bank Name: HSBC Singapore
Bank Address: 21, Collyer Quay, Singapore, 049320
Account Number: 123-456789-001
SWIFT Code: HSBCSGSG
IBAN: GB29 NWBK 6016 1331 9268 19"
        ></textarea>
        <div class="help">Used in: TCP</div>
      </div>

      <div class="card">
        <h2>Section 6: Insurance</h2>
        <label for="insuredValue">Insured Value (USD)</label>
        <input id="insuredValue" type="text" inputmode="numeric" placeholder="e.g.: 85,000,000" />
        <div class="help">Used in: Additional Clauses</div>
      </div>

      <div class="card">
        <h2>Section 7: Speed &amp; Consumption Warranties</h2>
        <div class="help">Used in: TPC Warranty</div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <div style="font-weight: 650; margin-bottom: 8px;">Speed (knots)</div>

            <label for="lfs">Laden Full Speed</label>
            <input id="lfs" type="number" step="0.1" value="14.5" />
            <div class="help">Placeholder: <span class="mono">{{LFS}}</span></div>

            <div class="hr"></div>

            <label for="les">Laden Economical Speed</label>
            <input id="les" type="number" step="0.1" value="12.5" />
            <div class="help">Placeholder: <span class="mono">{{LES}}</span></div>

            <div class="hr"></div>

            <label for="bfs">Ballast Full Speed</label>
            <input id="bfs" type="number" step="0.1" value="15.5" />
            <div class="help">Placeholder: <span class="mono">{{BFS}}</span></div>

            <div class="hr"></div>

            <label for="bes">Ballast Economical Speed</label>
            <input id="bes" type="number" step="0.1" value="12.5" />
            <div class="help">Placeholder: <span class="mono">{{BES}}</span></div>

            <div class="hr"></div>

            <label for="sss">Super Slow Speed</label>
            <input id="sss" type="number" step="0.1" value="10.0" />
            <div class="help">Placeholder: <span class="mono">{{SSS}}</span></div>
          </div>

          <div>
            <div style="font-weight: 650; margin-bottom: 8px;">
              Consumption (MT/day) <span class="req">*</span>
            </div>

            <label for="lfc">Laden Full Consumption <span class="req">*</span></label>
            <input id="lfc" type="number" step="0.1" placeholder="e.g., 78.5" required />
            <div class="help">Placeholder: <span class="mono">{{LFC}}</span></div>

            <div class="hr"></div>

            <label for="lec">Laden Economical Consumption <span class="req">*</span></label>
            <input id="lec" type="number" step="0.1" placeholder="e.g., 48.0" required />
            <div class="help">Placeholder: <span class="mono">{{LEC}}</span></div>

            <div class="hr"></div>

            <label for="bfc">Ballast Full Consumption <span class="req">*</span></label>
            <input id="bfc" type="number" step="0.1" placeholder="e.g., 68.0" required />
            <div class="help">Placeholder: <span class="mono">{{BFC}}</span></div>

            <div class="hr"></div>

            <label for="bec">Ballast Economical Consumption <span class="req">*</span></label>
            <input id="bec" type="number" step="0.1" placeholder="e.g., 45.0" required />
            <div class="help">Placeholder: <span class="mono">{{BEC}}</span></div>

            <div class="hr"></div>

            <label for="ssc">Super Slow Consumption <span class="req">*</span></label>
            <input id="ssc" type="number" step="0.1" placeholder="e.g., 32.0" required />
            <div class="help">Placeholder: <span class="mono">{{SSC}}</span></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="btnrow">
          <button id="generateBtn" class="primary" type="button">Generate All 4 Documents</button>
          <button id="clearBtn" class="secondary" type="button">Clear Downloads</button>
          <button id="checkBtn" class="secondary smallbtn" type="button">Check Template Links</button>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="status" class="status" style="display: none;"></div>

        <div id="downloads" class="downloads" style="display: none;"></div>

        <div class="note">
          <span class="warn">If you see a 404 for a template:</span> it usually means the file is not in the
          same folder as <span class="mono">index.html</span> on GitHub Pages.
          This page now tries multiple locations automatically:
          <span class="mono">(same folder → ./same folder → templates/ → GitHub raw)</span>.
        </div>

        <div class="note">
          <span class="warn">If you see "docxtemplater is not a constructor":</span> your browser loaded a
          build where the constructor is exposed under a different name (for example
          <span class="mono">window.docxtemplater.default</span>). This page now auto-detects the constructor.
        </div>
      </div>

      <div class="sub" style="margin-top: 18px;">
        Templates are fetched from this repo (same-origin when deployed on GitHub Pages), with a fallback to
        GitHub raw URLs.
      </div>
    </div>

    <!-- Libraries (browser usage) -->
    <!-- Official docs show the cdnjs build; we keep it, but our code auto-detects the constructor shape. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.66.4/docxtemplater.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.2.0/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.2.0/dist/pizzip-utils.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

    <script>
      // ---------------------------------------------------------------------------
      // Templates
      // ---------------------------------------------------------------------------
      // 404 happens when the template files are not reachable at the relative URL.
      // To be resilient (especially in previews / when files live under /templates),
      // we try multiple candidate URLs and fall back to raw.githubusercontent.com.

      const REPO_RAW_BASE =
        "https://raw.githubusercontent.com/tuka-2000/Pool_Document_Generator/main/";

      // IMPORTANT:
      // - `file` is the URL-encoded filename (spaces encoded as %20)
      // - We will attempt:
      //   1) file
      //   2) ./file
      //   3) templates/file
      //   4) REPO_RAW_BASE + file
      const TEMPLATES = [
        {
          key: "additional_clauses",
          label: "Additional Clauses",
          file: "Additional%20Clauses.docx",
          out: "Additional Clauses - {{VESSEL_NAME}}.docx",
        },
        {
          key: "pool_agreement",
          label: "Pool Agreement",
          file: "Pool%20Agreement.docx",
          out: "Pool Agreement - {{VESSEL_NAME}}.docx",
        },
        { key: "tcp", label: "TCP", file: "TCP.docx", out: "TCP - {{VESSEL_NAME}}.docx" },
        {
          key: "tpc_warranty",
          label: "TPC Warranty",
          file: "TPC%20Warranty.docx",
          out: "TPC Warranty - {{VESSEL_NAME}}.docx",
        },
      ];

      const el = (id) => document.getElementById(id);

      const state = {
        downloads: [], // { key, label, filename, blob, url }
        docxtemplaterCtor: null,
        docxtemplaterCtorLabel: null,
      };

      function setError(msg) {
        const e = el("error");
        if (!msg) {
          e.style.display = "none";
          e.textContent = "";
          return;
        }
        e.style.display = "block";
        e.textContent = msg;
      }

      function setStatus(msg) {
        const s = el("status");
        if (!msg) {
          s.style.display = "none";
          s.textContent = "";
          return;
        }
        s.style.display = "block";
        s.textContent = msg;
      }

      function revokeDownloads() {
        for (const d of state.downloads) {
          try {
            URL.revokeObjectURL(d.url);
          } catch (_) {}
        }
        state.downloads = [];
      }

      function renderDownloads() {
        const box = el("downloads");
        box.innerHTML = "";
        if (!state.downloads.length) {
          box.style.display = "none";
          return;
        }
        box.style.display = "grid";

        for (const d of state.downloads) {
          const wrap = document.createElement("div");
          wrap.className = "dlitem";

          const meta = document.createElement("div");
          meta.className = "dlmeta";
          const lbl = document.createElement("div");
          lbl.className = "dllabel";
          lbl.textContent = d.label;
          const file = document.createElement("div");
          file.className = "dlfile";
          file.textContent = d.filename;
          meta.appendChild(lbl);
          meta.appendChild(file);

          const btn = document.createElement("button");
          btn.className = "secondary";
          btn.textContent = "Download";
          btn.onclick = () => saveAs(d.blob, d.filename);

          wrap.appendChild(meta);
          wrap.appendChild(btn);
          box.appendChild(wrap);
        }
      }

      // ---------------------------------------------------------------------------
      // Library health checks
      // ---------------------------------------------------------------------------

      function describeValue(v) {
        if (v === null) return "null";
        if (v === undefined) return "undefined";
        const t = typeof v;
        if (t === "function") return "function";
        if (t !== "object") return t;
        try {
          return `object keys=[${Object.keys(v).slice(0, 15).join(",")}${Object.keys(v).length > 15 ? ",…" : ""}]`;
        } catch (_) {
          return "object";
        }
      }

      function pickDocxtemplaterConstructorFromGlobals(globals) {
        // We keep this function pure so we can unit-test it.
        // It returns { ctor, label } or null.
        const candidates = [];

        const direct = globals && globals.docxtemplater;
        if (typeof direct === "function") {
          candidates.push({ ctor: direct, label: "window.docxtemplater" });
        }

        // Some bundles expose { default: Docxtemplater } or { Docxtemplater: Docxtemplater }
        if (direct && typeof direct === "object") {
          for (const key of ["default", "Docxtemplater", "docxtemplater"]) {
            if (typeof direct[key] === "function") {
              candidates.push({ ctor: direct[key], label: `window.docxtemplater.${key}` });
            }
          }
          // As a last resort, scan function-valued keys
          try {
            for (const [k, v] of Object.entries(direct)) {
              if (typeof v === "function") {
                candidates.push({ ctor: v, label: `window.docxtemplater.${k}` });
              }
            }
          } catch (_) {}
        }

        const alt = globals && globals.Docxtemplater;
        if (typeof alt === "function") {
          candidates.push({ ctor: alt, label: "window.Docxtemplater" });
        }

        // Historical name used in some builds (old docxtemplater-build repo)
        const docxgen = globals && globals.Docxgen;
        if (typeof docxgen === "function") {
          candidates.push({ ctor: docxgen, label: "window.Docxgen" });
        }

        // Prefer stable labels first
        const preferred = [
          "window.docxtemplater",
          "window.Docxtemplater",
          "window.docxtemplater.default",
          "window.docxtemplater.Docxtemplater",
          "window.Docxgen",
        ];

        for (const p of preferred) {
          const hit = candidates.find((c) => c.label === p);
          if (hit) return hit;
        }
        return candidates[0] || null;
      }

      function ensureDocxtemplaterConstructor() {
        if (state.docxtemplaterCtor) return state.docxtemplaterCtor;

        const found = pickDocxtemplaterConstructorFromGlobals(window);
        if (!found) {
          const msg =
            "Docxtemplater library is not available in this page.\n\n" +
            "Troubleshooting:\n" +
            "• If you are testing on a corporate network, cdnjs may be blocked.\n" +
            "• Confirm this page can reach https://cdnjs.cloudflare.com/... in the browser.\n" +
            "• If blocked, we can self-host the JS files in the repo.\n\n" +
            `Diagnostics: window.docxtemplater=${describeValue(window.docxtemplater)}, window.Docxtemplater=${describeValue(window.Docxtemplater)}`;
          throw new Error(msg);
        }

        state.docxtemplaterCtor = found.ctor;
        state.docxtemplaterCtorLabel = found.label;
        return found.ctor;
      }

      // ---------------------------------------------------------------------------
      // Helpers
      // ---------------------------------------------------------------------------

      function londonIsoToday() {
        // YYYY-MM-DD in London time
        const parts = new Intl.DateTimeFormat("en-CA", {
          timeZone: "Europe/London",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        }).formatToParts(new Date());
        const y = parts.find((p) => p.type === "year").value;
        const m = parts.find((p) => p.type === "month").value;
        const d = parts.find((p) => p.type === "day").value;
        return `${y}-${m}-${d}`;
      }

      function formatLongLondonDate(iso) {
        if (!iso) return "";
        const [y, m, d] = iso.split("-").map(Number);
        const dt = new Date(Date.UTC(y, m - 1, d));
        return new Intl.DateTimeFormat("en-GB", {
          timeZone: "Europe/London",
          day: "2-digit",
          month: "long",
          year: "numeric",
        }).format(dt);
      }

      function normalizeOneDecimal(v) {
        if (v === "" || v == null) return "";
        const n = Number(v);
        if (!Number.isFinite(n)) return "";
        return n.toFixed(1);
      }

      function normalizeWholeNumberWithSeparators(v) {
        if (!v) return "";
        const digits = String(v).replace(/[^0-9]/g, "");
        if (!digits) return "";
        const n = Number(digits);
        if (!Number.isFinite(n)) return "";
        return new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 }).format(n);
      }

      function getCountryFromAddress(address) {
        const raw = (address || "").trim();
        if (!raw) return "";
        const lines = raw
          .split(/\r?\n/)
          .map((s) => s.trim())
          .filter(Boolean);
        const lastLine = lines[lines.length - 1] || "";
        const commaParts = lastLine
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        return commaParts[commaParts.length - 1] || lastLine;
      }

      function safeFilename(pattern, vesselName) {
        const safeVessel = (vesselName || "Vessel").replace(/[^a-z0-9\- _]/gi, "");
        return pattern.replace("{{VESSEL_NAME}}", safeVessel);
      }

      function candidateTemplateUrls(file) {
        // Keep ordering: most likely first.
        return [file, `./${file}`, `templates/${file}`, `${REPO_RAW_BASE}${file}`];
      }

      function loadBinaryFromUrl(url) {
        return new Promise((resolve, reject) => {
          PizZipUtils.getBinaryContent(url, (err, content) => {
            if (err) reject(err);
            else resolve(content);
          });
        });
      }

      async function loadTemplateBinary(tpl) {
        const urls = candidateTemplateUrls(tpl.file);
        let lastErr = null;

        for (const url of urls) {
          try {
            const content = await loadBinaryFromUrl(url);
            return { content, url };
          } catch (err) {
            lastErr = err;
            const status = err && (err.status || err.statusCode);
            if (status === 404) continue;
            continue;
          }
        }

        const status = lastErr && (lastErr.status || lastErr.statusCode);
        const msg =
          `Ajax error for ${tpl.file}: status ${status || "(unknown)"}. ` +
          `Tried: ${urls.join(" | ")}. ` +
          `\n\nFix: ensure the file exists in the same folder as index.html on GitHub Pages, ` +
          `or place it under /templates/.`;
        const e = new Error(msg);
        e.cause = lastErr;
        throw e;
      }

      // ---------------------------------------------------------------------------
      // Template data mapping
      // ---------------------------------------------------------------------------

      function buildDataForDoc(docKey, inputs) {
        const agreementDate = formatLongLondonDate(inputs.agreementDateIso);

        const appendix2DateForPoolAgreement = inputs.appendix2Applicable
          ? formatLongLondonDate(inputs.headTcpDateIso) || agreementDate
          : agreementDate;

        const agreementDateAppendix2 =
          docKey === "pool_agreement" ? appendix2DateForPoolAgreement : agreementDate;

        const computedTimeCharterer = inputs.appendix2Applicable
          ? (inputs.timeCharterers || "").trim()
          : "Tankers International Limited";

        const participantCountry = getCountryFromAddress(inputs.participantAddress);

        return {
          AGREEMENT_DATE: agreementDate,
          AGREEMENT_DATE_APPENDIX2: agreementDateAppendix2,

          VESSEL_NAME: (inputs.vesselName || "").trim(),
          CLASSIFICATION_SOCIETY: docKey === "tcp" ? (inputs.classificationSociety || "").trim() : "",

          PARTICIPANT_NAME:
            docKey === "pool_agreement" || docKey === "tcp" || docKey === "tpc_warranty"
              ? (inputs.participantName || "").trim()
              : "",
          PARTICIPANT_ADDRESS:
            docKey === "pool_agreement" || docKey === "tcp" ? (inputs.participantAddress || "").trim() : "",
          PARTICIPANT_COUNTRY: docKey === "tcp" ? participantCountry : "",
          NOTICE_DETAIL: docKey === "pool_agreement" ? (inputs.noticeDetail || "").trim() : "",

          TIME_CHARTERER_APPENDIX2: docKey === "pool_agreement" ? computedTimeCharterer : "",

          BANKING_DETAIL: docKey === "tcp" ? (inputs.bankingDetail || "").trim() : "",
          INSURED_VALUE:
            docKey === "additional_clauses" ? normalizeWholeNumberWithSeparators(inputs.insuredValue) : "",

          LFS: docKey === "tpc_warranty" ? normalizeOneDecimal(inputs.lfs) : "",
          LFC: docKey === "tpc_warranty" ? normalizeOneDecimal(inputs.lfc) : "",
          LES: docKey === "tpc_warranty" ? normalizeOneDecimal(inputs.les) : "",
          LEC: docKey === "tpc_warranty" ? normalizeOneDecimal(inputs.lec) : "",
          BFS: docKey === "tpc_warranty" ? normalizeOneDecimal(inputs.bfs) : "",
          BFC: docKey === "tpc_warranty" ? normalizeOneDecimal(inputs.bfc) : "",
          BES: docKey === "tpc_warranty" ? normalizeOneDecimal(inputs.bes) : "",
          BEC: docKey === "tpc_warranty" ? normalizeOneDecimal(inputs.bec) : "",
          SSS: docKey === "tpc_warranty" ? normalizeOneDecimal(inputs.sss) : "",
          SSC: docKey === "tpc_warranty" ? normalizeOneDecimal(inputs.ssc) : "",
        };
      }

      function generateDocxFromBinaryContent(binaryContent, data) {
        const zip = new PizZip(binaryContent);

        const DocxtemplaterCtor = ensureDocxtemplaterConstructor();

        let doc;
        try {
          doc = new DocxtemplaterCtor(zip, {
            paragraphLoop: true,
            linebreaks: true,
            delimiters: { start: "{{", end: "}}" },
            nullGetter: () => "",
          });
        } catch (e) {
          // Extra diagnostics if a candidate isn't constructable.
          const msg =
            `Docxtemplater constructor failed (${state.docxtemplaterCtorLabel || "unknown"}).\n` +
            `Original error: ${String(e && e.message ? e.message : e)}\n\n` +
            `Diagnostics: window.docxtemplater=${describeValue(window.docxtemplater)}, window.Docxtemplater=${describeValue(window.Docxtemplater)}`;
          const err = new Error(msg);
          err.cause = e;
          throw err;
        }

        doc.render(data);
        return doc.toBlob();
      }

      function validateRequired(inputs) {
        const missing = [];
        if (!inputs.agreementDateIso) missing.push("Agreement Date");
        if (!inputs.vesselName.trim()) missing.push("Vessel Name");
        if (!inputs.participantName.trim()) missing.push("Participant/Owner Name");

        if (!normalizeOneDecimal(inputs.lfc)) missing.push("Laden Full Consumption");
        if (!normalizeOneDecimal(inputs.lec)) missing.push("Laden Economical Consumption");
        if (!normalizeOneDecimal(inputs.bfc)) missing.push("Ballast Full Consumption");
        if (!normalizeOneDecimal(inputs.bec)) missing.push("Ballast Economical Consumption");
        if (!normalizeOneDecimal(inputs.ssc)) missing.push("Super Slow Consumption");

        return missing;
      }

      async function onGenerate() {
        setError("");
        setStatus("");

        revokeDownloads();
        renderDownloads();

        const inputs = {
          agreementDateIso: el("agreementDate").value,
          vesselName: el("vesselName").value,
          classificationSociety: el("classSoc").value,
          participantName: el("participantName").value,
          participantAddress: el("participantAddress").value,
          noticeDetail: el("noticeDetail").value,
          appendix2Applicable: el("appendix2").checked,
          headTcpDateIso: el("headTcpDate").value,
          timeCharterers: el("timeCharterers").value,
          bankingDetail: el("bankingDetail").value,
          insuredValue: el("insuredValue").value,
          lfs: el("lfs").value,
          lfc: el("lfc").value,
          les: el("les").value,
          lec: el("lec").value,
          bfs: el("bfs").value,
          bfc: el("bfc").value,
          bes: el("bes").value,
          bec: el("bec").value,
          sss: el("sss").value,
          ssc: el("ssc").value,
        };

        const missing = validateRequired(inputs);
        if (missing.length) {
          setError("Please fill in all required fields (marked with *)");
          return;
        }

        const btn = el("generateBtn");
        btn.disabled = true;

        try {
          // Force constructor resolution early for a cleaner error.
          const ctor = ensureDocxtemplaterConstructor();
          setStatus(`Docxtemplater ready (${state.docxtemplaterCtorLabel}). Starting generation...`);
          void ctor; // (lint friendly)

          const out = [];

          for (let i = 0; i < TEMPLATES.length; i++) {
            const t = TEMPLATES[i];
            setStatus(`(${i + 1}/${TEMPLATES.length}) Downloading template: ${t.label}...`);

            const { content: binaryContent, url: usedUrl } = await loadTemplateBinary(t);

            setStatus(
              `(${i + 1}/${TEMPLATES.length}) Replacing placeholders: ${t.label}... (loaded from: ${usedUrl})`
            );

            const data = buildDataForDoc(t.key, inputs);
            const blob = generateDocxFromBinaryContent(binaryContent, data);

            const filename = safeFilename(t.out, data.VESSEL_NAME);
            const url = URL.createObjectURL(blob);
            out.push({ key: t.key, label: t.label, filename, blob, url });
          }

          state.downloads = out;
          renderDownloads();
          setStatus("Done. Click Download for each file.");
        } catch (err) {
          console.error(err);
          setError(String(err && err.message ? err.message : err));
        } finally {
          btn.disabled = false;
        }
      }

      function onClearDownloads() {
        setError("");
        setStatus("");
        revokeDownloads();
        renderDownloads();
      }

      async function onCheckTemplates() {
        setError("");
        setStatus("Checking template links...");

        try {
          // Also validate Docxtemplater availability during checks.
          const found = pickDocxtemplaterConstructorFromGlobals(window);
          if (!found) {
            throw new Error(
              "Docxtemplater is not available. This usually means the docxtemplater <script> failed to load (often a 404 due to a non-existent cdnjs version, or a blocked CDN). If needed, we can self-host the JS files in the repo."
            );
          }

          for (let i = 0; i < TEMPLATES.length; i++) {
            const t = TEMPLATES[i];
            const urls = candidateTemplateUrls(t.file);
            setStatus(`Checking: ${t.label}...`);

            let okUrl = null;
            for (const u of urls) {
              try {
                await loadBinaryFromUrl(u);
                okUrl = u;
                break;
              } catch (e) {
                const status = e && (e.status || e.statusCode);
                if (status === 404) continue;
                continue;
              }
            }

            if (!okUrl) {
              throw new Error(`Template not reachable: ${t.file} (tried: ${urls.join(" | ")})`);
            }
          }
          setStatus(`All templates are reachable. Docxtemplater: ${found.label}`);
        } catch (e) {
          console.error(e);
          setError(String(e && e.message ? e.message : e));
          setStatus("");
        }
      }

      function init() {
        const todayIso = londonIsoToday();
        el("agreementDate").value = todayIso;
        el("headTcpDate").value = todayIso;
        el("agreementDateHelp").textContent = `Used in: All documents • Output format: ${formatLongLondonDate(
          todayIso
        )}`;

        el("agreementDate").addEventListener("change", () => {
          const iso = el("agreementDate").value;
          el("agreementDateHelp").textContent =
            `Used in: All documents • Output format: ${formatLongLondonDate(iso) || "(select a date)"}`;
        });

        el("participantAddress").addEventListener("input", () => {
          const c = getCountryFromAddress(el("participantAddress").value);
          el("countryHelp").textContent =
            `Used in: Pool Agreement, TCP • Country detected for TCP: ${c || "(not detected)"}`;
        });

        el("insuredValue").addEventListener("input", (ev) => {
          const v = normalizeWholeNumberWithSeparators(ev.target.value);
          ev.target.value = v;
        });

        el("appendix2").addEventListener("change", () => {
          const on = el("appendix2").checked;
          el("appendix2Fields").style.display = on ? "block" : "none";
          if (!on) {
            el("headTcpDate").value = todayIso;
            el("timeCharterers").value = "";
          }
        });

        el("generateBtn").addEventListener("click", onGenerate);
        el("clearBtn").addEventListener("click", onClearDownloads);
        el("checkBtn").addEventListener("click", onCheckTemplates);

        // Initial diagnostics (non-fatal)
        try {
          const found = pickDocxtemplaterConstructorFromGlobals(window);
          if (found) {
            setStatus(`Docxtemplater detected: ${found.label}`);
          } else {
            setStatus(
              "Docxtemplater not detected yet. If generation fails, click 'Check Template Links' for diagnostics."
            );
          }
        } catch (_) {
          // ignore
        }
      }

      // ---------------------------------------------------------------------------
      // Very small self-tests (keep existing, add new)
      // ---------------------------------------------------------------------------
      console.assert(formatLongLondonDate("2025-06-01") === "01 June 2025", "date format");
      console.assert(normalizeOneDecimal("14") === "14.0", "one decimal");
      console.assert(normalizeWholeNumberWithSeparators("85000000") === "85,000,000", "separators");
      console.assert(
        candidateTemplateUrls("Additional%20Clauses.docx")[3] === REPO_RAW_BASE + "Additional%20Clauses.docx",
        "candidateTemplateUrls raw fallback"
      );

      // New test: constructor picker should find 'default' if that's where the constructor lives
      (function () {
        function Fake() {}
        const globals = { docxtemplater: { default: Fake } };
        const picked = pickDocxtemplaterConstructorFromGlobals(globals);
        console.assert(picked && picked.ctor === Fake, "constructor picker finds window.docxtemplater.default");
      })();

      init();
    </script>
  </body>
</html>
